var globalPrintformerOptions=null;var printformerInstance=null;define(["jquery","jquery/ui","jquery/jquery.parsequery","Magento_Ui/js/modal/modal","mage/translate"],function(c,b,e,a,d){c.widget("mage.printformer",{formatChange:false,currentDrafts:null,isDefined:function(f){return typeof f!==typeof undefined},getUploadUrl:function(){return this.printformerOptions.urls.upload},getUploadAndEditorUrl:function(){return this.printformerOptions.urls.uploadAndEditor},getPersonalizeUrl:function(){return this.printformerOptions.urls.personalize},getEditorUrl:function(){var g=this.printformerOptions,m=g.urls.customize.split("?"),f=m[0],i=c(g.qtySelector),l=c('[data-action="add-to-wishlist"]').data("post"),k=c('[name="form_key"]'),h="";var j=null;if(l){j=l.action.split("/")}f+="?";f+=m[1];if(i.val()){f+=encodeURIComponent("qty/"+i.val())}if(k){f+=encodeURIComponent("/form_key/"+k.val())}if(j!==null){c.each(j,function(n,o){if(o==="wishlist"||o==="index"){h+=o+"/"}else{if(o==="updateItemOptions"){h+=o}}})}f+=encodeURIComponent("?");if(l){c.each(l.data,function(n,o){if(n!=="product"&&n!=="qty"&&n!=="uenc"){f+=encodeURIComponent("&"+n+"="+o)}})}if(h.length){f+=encodeURIComponent("&updateWishlistItemOptions="+h)}return f},initPersonalisationQty:function(){var n=this;if(this.isDefined(this.printformerOptions.personalizations)&&this.printformerOptions.personalizations>1){var o=c(this.printformerOptions.qtySelector);var l=parseInt(n.printformerOptions.personalizations);if(c(o).prop("tagName").toLowerCase()==="select"&&!this.persoOptionAdded){l=parseFloat(n.printformerOptions.personalizations);var k=c("<option/>");c(k).val(l);c(k).text(this.printformerOptions.personalizations);var g=c(o).children();for(var j=0;j<g.length;j++){var p=parseFloat(c(g[j]).val());var m=parseFloat(c(g[j+1]).val());if(p<l&&m>l){c(g[j+1]).after(c(k));this.persoOptionAdded=true;break}}}c(o).val(l);c(o).data("pf-perso-count",this.printformerOptions.personalizations);var h=null;if(c("#personalisation_qty").length<1){h=c("<input/>").attr("type","text").attr("class",c(o).attr("class")).attr("id","personalisation_qty").val(this.printformerOptions.personalizations).prop("disabled",true);c(h).insertAfter(c(o))}c(o).data("pf-personalized","true");c(o).trigger("change").hide();if(c("#printformer_personalisations").length<1){var f=c('<input value="'+this.printformerOptions.personalizations+'" type="hidden" id="printformer_personalisations" name="printformer_personalisations"/>');c(f).insertAfter(c(h))}}},_create:function(){var f=this;this.form=this.element;this.callbacks={};this.addToCartFormUrl=null;this.persoOptionAdded=false;this.printformerOptions=this.options;globalPrintformerOptions=this.printformerOptions;if(this.isDefined(printformerInstance)){printformerInstance=this}c(document).trigger("printformer:loaded:before");this.runCallbacks("printformer:loaded:before");this._initEditorMain();c.ajax({url:f.printformerOptions.DraftsGetUrl+"product/"+f.printformerOptions.ProductId+"/",method:"get",dataType:"json"}).done(function(g){f.currentDrafts=g;f._initAddBtn();f._initEditBtn();f._initUploadBtn();f._initVariations();if(f.printformerOptions.isConfigure){f.hideSecondButton();f.setPrimaryButton()}if(f.isDefined(f.printformerOptions.personalizations_conf)&&f.printformerOptions.personalizations_conf&&f.isDefined(f.printformerOptions.personalizations)&&f.printformerOptions.personalizations>1){f.initPersonalisationQty()}if(f.isDefined(f.printformerOptions.preselection)&&f.printformerOptions.preselection!==null){f.preselectOptions(f.printformerOptions.preselection)}if(f.isDefined(f.printformerOptions.personalizations)&&f.printformerOptions.personalizations>1){f.initPersonalisationQty()}c(document).trigger("printformer:loaded");f.runCallbacks("printformer:loaded:after")})},hideSecondButton:function(){if(c(this.uploaBtn).length){c(this.uploaBtn).hide()}},setPrimaryButton:function(){var j=this;var g=this.printformerOptions.currentSessionIntent;var f="editor";var h=d("View draft");if(g==="upload"||g==="upload-and-editor"){f="upload";h=d("View upload")}c(this.editBtn).attr("data-pf-masterid",this.printformerOptions.masterId);c(this.editBtn).attr("data-pf-type",f);c(this.editBtn).attr("data-pf-intent",g);if(f==="upload"){c(this.editBtn).unbind("click");c(this.editBtn).click({printformer:this},function(l){var k=g==="upload-and-editor"?j.getUploadAndEditorUrl():j.getUploadUrl();l.data.printformer.editorMainOpen(k)})}if(c(this.editBtn).length){var i=c(this.editBtn).children("span");c(i).text(h)}},_initEditorMain:function(){var f=this.printformerOptions;this.editorMain=c(f.editorMainSelector);this.editorMain.modal({modalClass:"printformer-editor-main-modal",title:f.productTitle,buttons:[],modalCloseBtnHandler:this.editorCloseOpen.bind(this)});this._initEditorClose();this._initEditorNotice()},editorMainOpen:function(f){this.addToCartFormUrl=c(this.form).attr("action");c(this.form).attr("action",f);c(this.form).attr("target","printformer-main-frame");c("html, body").css({overflow:"hidden",height:"100%",width:"100%"});this.editorMain.modal("openModal");this.editorMain.html(c('<iframe width="100%" height="100%" name="printformer-main-frame"/>'));c(this.form).off().submit()},resetForm:function(){c(this.form).attr("action",this.addToCartFormUrl);c(this.form).removeAttr("target")},_initEditorClose:function(){var f=this.printformerOptions;this.editorClose=c(f.editorCloseSelector);this.editorClose.modal({modalClass:"printformer-editor-close-modal",modalCloseBtnHandler:this.editorCloseCancel.bind(this),buttons:[{text:d("Yes"),"class":"ok-btn",click:this.editorCloseOk.bind(this)},{text:d("No"),"class":"cancel-btn",click:this.editorCloseCancel.bind(this)}]})},editorCloseOpen:function(){this.editorClose.modal("openModal")},editorCloseOk:function(){this.editorMain.modal("closeModal");this.editorClose.modal("closeModal");c("html, body").css({overflow:"auto",height:"auto",width:"auto"});this.editorMain.html("");this.resetForm()},editorCloseCancel:function(){this.editorClose.modal("closeModal");this.resetForm()},_initEditorNotice:function(){var f=this.printformerOptions;this.editorNotice=c(f.editorNoticeSelector);if(!this.editorNotice){return}this.editorNotice.modal({modalClass:"printformer-editor-notice-modal",modalCloseBtnHandler:this.editorNoticeCancel.bind(this),buttons:[{text:"OK","class":"ok-btn",click:this.editorNoticeOk.bind(this)},{text:"Cancel","class":"cancel-btn",click:this.editorNoticeCancel.bind(this)}]})},editorNoticeOpen:function(){this.editorNotice.modal("openModal")},editorNoticeOk:function(){this.formatChange=true;this.editorNotice.modal("closeModal");this.resetForm()},editorNoticeCancel:function(){this.formatChange=false;this.editorNotice.modal("closeModal");if(!this.formatChange){for(var f in this.printformerOptions.variationsFront){c("#"+f).val(this.printformerOptions.variationsFront[f]).trigger("change",{skip:true})}}this.resetForm()},setButtonText:function(f,i){var h=c(f).children("span");var g=c(h).children("i");c(h).text(i);if(c(g).length){c(h).text(" "+c(h).text());c(h).prepend(c(g))}},isUploadProduct:function(){return(this.printformerOptions.currentSessionIntent==="upload-and-editor"||this.printformerOptions.currentSessionIntent==="upload")},_initAddBtn:function(){var f=this.printformerOptions;this.addBtn=c(f.addBtnSelector);var g=null;if(f.draftId){g=c('<input value="'+f.draftId+'" type="hidden" id="printformer_draftid" name="printformer_draftid"/>');c(f.qtySelector).after(g)}var i=null;if(g&&f.intent){i=c('<input value="'+f.intent+'" type="hidden" id="printformer_intent" name="printformer_intent"/>');c(g).after(i)}var h=null;if(g&&i&&f.unique_id){h=c('<input value="'+f.unique_id+'" type="hidden" id="printformer_unique_session_id" name="printformer_unique_session_id"/>');c(i).after(h)}this.addBtnDisable()},addBtnEnable:function(){this.addBtn.prop("disabled",false)},addBtnDisable:function(){var f=this.printformerOptions;if(!f.allowAddCart){this.addBtn.prop("disabled",true)}},_initEditBtn:function(){var g=this;var f=this.printformerOptions;this.editBtn=c(this.printformerOptions.editBtnSelector);this.editBtn.click({printformer:this},function(i){if(c(g.editBtn).data("pf-intent")==="personalize"){i.data.printformer.editorMainOpen(g.getPersonalizeUrl())}else{i.data.printformer.editorMainOpen(g.getEditorUrl())}}).show();var h=false;if(this.currentDrafts){if(this.isDefined(this.currentDrafts.customize)){h=true}else{if(this.isDefined(this.currentDrafts.personalize)){h=true}}}if(h){this.setButtonText(c(this.editBtn),d("View draft"))}},editBtnEnable:function(){this.editBtn.prop("disabled",false)},editBtnDisable:function(){this.editBtn.prop("disabled",true)},_initUploadBtn:function(){var j=this;var h=this.printformerOptions;this.uploaBtn=c(this.printformerOptions.uploadBtnSelector);var f=false;var g=j.getUploadUrl();if(c(j.uploaBtn).data("pf-intent")==="upload-and-editor"){g=j.getUploadAndEditorUrl();f=true}this.uploaBtn.click({printformer:this},function(l){l.data.printformer.editorMainOpen(g)}).show();var i=(f?"upload-and-editor":"upload");var k=false;if(this.currentDrafts&&this.isDefined(this.currentDrafts[i])){k=true}if(k){this.setButtonText(c(this.uploaBtn),d("View upload"))}},uploadBtnEnable:function(){this.uploadBtn.prop("disabled",false)},uploadBtnDisable:function(){c(this.uploadBtn).prop("disabled",true)},_initVariations:function(){var j=this.printformerOptions.variationsConfig;if(typeof j!=="object"){return}for(var i in j){var h=c("#"+i);if(!h.length){continue}this.editBtnDisable();this.uploadBtnDisable();h.change({printformer:this},function(l,k){if(k){return}l.data.printformer.setVariation(c(this).attr("id"),c(this).val())});for(var g in this.printformerOptions.variations){if(j[i]["param"]===g){for(var f in j[i]["map"]){if(j[i]["map"][f]===this.printformerOptions.variations[g]){h.val(f)}}}}h.change()}if(this.isDefined(this.printformerOptions.preselection)&&this.printformerOptions.preselection!==null){if(parseInt(this.printformerOptions.preselection.qty.value)!==parseInt(this.printformerOptions.qty)){this.printformerOptions.qty=this.printformerOptions.preselection.qty.value}}if(this.printformerOptions.qty&&c(this.printformerOptions.qtySelector).prop("tagName")!=="SELECT"){c(this.printformerOptions.qtySelector).val(this.printformerOptions.qty)}},setVariation:function(i,g){var h=this.printformerOptions.variationsConfig;if(!i||!h[i]||!h[i]["param"].length){return}if(!this.formatChange&&h[i]["notice"]&&this.printformerOptions.variationsFront[i]!==undefined&&this.printformerOptions.variationsFront[i].length){this.editorNotice.modal("openModal");return}this.editBtnEnable();this.uploadBtnEnable();this.printformerOptions.variationsFront[i]=g;this.printformerOptions.variations[h[i]["param"]]=h[i]["map"][g];for(var f in this.printformerOptions.variations){if(this.printformerOptions.variations[f]===undefined||!this.printformerOptions.variations[f].length){this.editBtnDisable();this.uploadBtnDisable()}}},preselectOptions:function(j){this.runCallbacks("printformer:preselection:before");var h=this;if(!this.isDefined(j)){return}if(j.product===h.printformerOptions.ProductId){if(this.isDefined(j.qty)&&this.isDefined(j.qty.value)){var g="#qty";if(c(g).length){if(c(g).prop("tagName").toLowerCase()==="input"){c(g).val(parseInt(j.qty.value))}else{c(g).val(j.qty.value)}c(g).trigger("change")}}if(this.isDefined(j.options)&&j.options!==null){var i=c(".product-options-wrapper :input");var f=null;c.each(i,function(l,k){if(c(k).hasClass("product-custom-option")&&(c(k).is("textarea")||c(k).attr("type")==="text")){var m=new RegExp(/options_([0-9]+)_.*/i);f=c(k).attr("id").replace(m,"$1");if(h.isDefined(j.options[f])){c(k).val(j.options[f].value)}}if(c(k).hasClass("product-custom-option")&&c(k).attr("type")==="checkbox"){var n=c(k).attr("id").replace(/options_([0-9]+)_[0-9]+/i,"$1");if(h.isDefined(j.options[n])){c.each(j.options[n].value,function(q,p){if(c(k).val()===p){c(k).prop("checked",true)}})}}if(c(k).prop("tagName").toLowerCase()==="select"&&c(k).hasClass("product-custom-option")){if(c(k).hasClass("datetime-picker")){c.each(j.options,function(o,p){if(c(k).data("selector")==="options["+o+"]["+c(k).data("calendar-role")+"]"){if(h.isDefined(p.value[c(k).data("calendar-role")])){c(k).val(p.value[c(k).data("calendar-role")])}}})}else{c.each(j.options,function(o,p){if(c(k).data("selector")==="options["+o+"]"){c(k).val(p.value)}})}}if(c(k).hasClass("product-custom-option")&&c(k).attr("type")==="radio"){c.each(j.options,function(o,p){if(c(k).data("selector")==="options["+o+"]"&&c(k).val()===p.value){c(k).prop("checked",true)}})}c(k).trigger("change")})}}this.runCallbacks("printformer:preselection:after");return this},registerCallback:function(g,f,h){if(!this.isDefined(this.callbacks[g])){this.callbacks[g]={}}this.callbacks[g][f]=h;c(document).trigger("printformer_callback_registered",g,f,h)},runCallbacks:function(f){if(!this.isDefined(f)){c.each(this.callbacks,function(h,g){c.each(g,function(k,j){j()})})}else{c.each(this.callbacks[f],function(h,g){g()})}}});return c.mage.printformer});